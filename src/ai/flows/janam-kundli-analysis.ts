// This is an autogenerated file from Firebase Studio.
'use server';
/**
 * @fileOverview A Janam Kundli analysis AI agent.
 *
 * - janamKundliAnalysis - A function that handles the Janam Kundli analysis process.
 * - JanamKundliAnalysisInput - The input type for the janamKundliAnalysis function.
 * - JanamKundliAnalysisOutput - The return type for the janamKundliAnalysis function.
 */

import {ai} from '@/ai/genkit';
import { getKundliData, getVedicYogasAndDoshas, getVimshottariDasha, type PlanetData, type Mahadasha } from '@/lib/astrology-service';
import {z} from 'genkit';

const JanamKundliAnalysisInputSchema = z.object({
  name: z.string().describe('The name of the person.'),
  dateOfBirth: z.string().describe('The date of birth of the person (YYYY-MM-DD).'),
  timeOfBirth: z.string().describe('The time of birth of the person (HH:MM).'),
  placeOfBirth: z.string().describe('The place of birth of the person (e.g., city, region, country).'),
  lat: z.number().optional().describe('Latitude of the place of birth.'),
  lon: z.number().optional().describe('Longitude of the place of birth.'),
});
export type JanamKundliAnalysisInput = z.infer<typeof JanamKundliAnalysisInputSchema>;

const ChartDataSchema = z.object({
    ascendant: z.string(),
    houses: z.array(z.object({
        house: z.number(),
        sign: z.string(),
        planets: z.array(z.string()),
    }))
});

const JanamKundliAnalysisOutputSchema = z.object({
    report: z.string().describe('A detailed Janam Kundli report including planetary positions, Lagna, Nakshatra, Dasha periods, and their significance.'),
    mahadashas: z.array(z.object({
        dashaLord: z.string(),
        startDate: z.string(),
        endDate: z.string(),
    })).describe('The calculated Vimshottari Mahadasha periods.'),
    chartData: ChartDataSchema.optional().describe('The data required to render the visual birth chart.'),
});
export type JanamKundliAnalysisOutput = z.infer<typeof JanamKundliAnalysisOutputSchema>;

export async function janamKundliAnalysis(input: JanamKundliAnalysisInput): Promise<JanamKundliAnalysisOutput> {
  return janamKundliAnalysisFlow(input);
}

const prompt = ai.definePrompt({
  name: 'janamKundliAnalysisPrompt',
  input: {schema: z.any()},
  output: {schema: z.object({ report: z.string() })}, // AI only generates the report text
  config: {
    temperature: 0.2,
  },
  prompt: `You are an expert Vedic astrologer. Your primary task is to interpret a pre-calculated Janam Kundli (birth chart) and generate a detailed report.

You have been provided with the raw astrological data calculated using the highly accurate Swiss Ephemeris. Do not attempt to recalculate anything. Your task is to act as a professional astrologer and interpret this data for the user.

User Details:
Name: {{{name}}}
Date of Birth: {{{dateOfBirth}}}
Time of Birth: {{{timeOfBirth}}}
Place of Birth: {{{placeOfBirth}}}

Calculated Astrological Data:
- Ascendant (Lagna): {{ascendant.degree}} degrees in {{ascendant.sign}}
- Planetary Positions:
  {{#each planets}}
  - {{this.name}}: {{this.degree}} degrees in {{this.sign}} (in house {{this.house}})
  {{/each}}
- Detected Yogas and Doshas:
  {{#each yogasAndDoshas}}
  - {{this.name}}: {{this.description}}
  {{else}}
  - No major doshas or yogas detected in this preliminary analysis.
  {{/each}}
- Major Dasha Periods (Vimshottari Mahadasha):
  {{#each mahadashas}}
  - {{this.dashaLord}}: from {{this.startDate}} to {{this.endDate}}
  {{/each}}


Based *only* on the provided data, generate a comprehensive Janam Kundli report. The report must include:
1.  A detailed analysis of the Lagna (Ascendant) and its meaning for the person's personality and life.
2.  An interpretation of each planet's position in its respective sign and house, and how it influences various aspects of life.
3.  A detailed section on the detected Yogas or Doshas. For each, explain its implications clearly and calmly. Explain which planetary combination caused it based on the data provided.
4.  A section on the Vimshottari Dasha periods. Briefly explain the general influence of the first 3-4 Mahadasha lords in this person's life based on their planetary positions in the chart.
5.  Provide a comprehensive analysis of career, health, and relationships based on the chart.
6.  Suggest simple, practical, and non-superstitious remedies if any challenging planetary positions or doshas are found.

Provide a comprehensive, well-structured, and easy-to-understand report. Your goal is to provide a complete astrological analysis based on the given data.`,
});

const janamKundliAnalysisFlow = ai.defineFlow(
  {
    name: 'janamKundliAnalysisFlow',
    inputSchema: JanamKundliAnalysisInputSchema,
    outputSchema: JanamKundliAnalysisOutputSchema,
  },
  async (input): Promise<JanamKundliAnalysisOutput> => {
    // In a real app, you would use a geocoding service to get lat/lon from placeOfBirth
    // For this prototype, we'll use a fixed lat/lon if not provided.
    const lat = input.lat ?? 19.2288; // Default to Kandivali, Mumbai
    const lon = input.lon ?? 72.8540; // Default to Kandivali, Mumbai

    const [year, month, day] = input.dateOfBirth.split('-').map(Number);
    const [hour, minute] = input.timeOfBirth.split(':').map(Number);
    
    // We need the original birth date for Dasha calculation
    const birthDateObj = new Date(year, month - 1, day, hour, minute);

    const kundliData = await getKundliData({ date: birthDateObj, lat, lon });
    const yogasAndDoshas = await getVedicYogasAndDoshas(kundliData.planets, kundliData.ascendant.sign);

    const moon = kundliData.planets.find(p => p.name === 'Moon');
    if (!moon) throw new Error("Could not calculate Moon's position.");
    const mahadashas = await getVimshottariDasha(moon.degree, birthDateObj);

    const promptInput = {
        ...input,
        ...kundliData,
        yogasAndDoshas,
        mahadashas
    };

    const {output} = await prompt(promptInput);

    // Prepare data for the visual chart
    const housesForChart = Array.from({ length: 12 }, (_, i) => ({
        house: i + 1,
        sign: kundliData.houseSigns[i],
        planets: kundliData.planets.filter(p => p.house === i + 1).map(p => p.name.substring(0, 2).toUpperCase())
    }));
    
    return {
        report: output!.report,
        mahadashas: mahadashas.map(d => ({
            dashaLord: d.dashaLord,
            startDate: d.startDate,
            endDate: d.endDate,
        })),
        chartData: {
            ascendant: kundliData.ascendant.sign,
            houses: housesForChart
        }
    };
  }
);
